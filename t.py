import os
import subprocess
import re

# read domains from target.txt
with open("target.txt", "r") as f:
    domains = f.readlines()

# remove newline characters
domains = [x.strip() for x in domains]

# loop through each domain
for domain in domains:
    # create directory named after the domain
    os.makedirs(domain, exist_ok=True)
    # change the current working directory to the domain directory
    os.chdir(domain)
    # run dnsmap on the domain
    out, error = subprocess.Popen(["dnsmap", domain], stdout=subprocess.PIPE, stderr=subprocess.PIPE).communicate()
    # decode the output
    out = out.decode()
    # write the output to a file named "scanned.txt"
    with open("scanned.txt", "w") as f:
        f.write(out)
    with open("scanned.txt", 'r') as f:
        # Read the contents of the file into a variable
        text = f.read()
    # Extract IP addresses from the text
    ip_addresses = re.findall(r'\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b', text)
    # Split the text into lines
    lines = text.split("\n")
    # Create a dictionary to store the subdomains and their corresponding IP addresses
    subdomains = {}
    # Iterate over the lines
    for i, line in enumerate(lines):
        # Check if the line contains an IP address
        if re.search(r'\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b', line):
            # Extract the subdomain from the previous line
            subdomain = lines[i-1]
            # Extract the IP address from the current line
            ip_address = line.split(":")[1].strip()
            # Add the subdomain and IP address to the dictionary
            subdomains[subdomain] = ip_address
    # Iterate over the subdomains and their corresponding IP addresses
    for subdomain, ip_address in subdomains.items():
        print(f"{subdomain}: {ip_address}")
    anum = []
    x = 0
    for subdomain, ip_address in subdomains.items():
        x = x + 1
        a = (f"{subdomain}: {ip_address}\n")
        b = ip_address
        # print(a)
        anum.append(b)
    print(anum)
    print(x)
    ip_list = anum
    # Open the file

    # Open the file in write mode
    with open('ips.txt', 'w') as f:
        # Write each IP address to a separate line in the file
        for ip in ip_list:
            f.write(ip + '\n')
    with open('domain.txt', 'w') as f:
        # Write each IP address to a separate line in the file
        for subdomain in subdomains:
            f.write(subdomain + '\n')
    out, error = subprocess.Popen(["nmap", "-Pn", "--system-dns", "-sV", "-iL", "ips.txt", "-oX", "scan_results.xml"],
                                  stdout=subprocess.PIPE, stderr=subprocess.PIPE).communicate()
    # Convert the `out` variable to a string object
    out = out.decode()
    # Write the output to a file
    with open("log_nmap.txt", "w") as f:
        f.write(out)
