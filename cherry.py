# Import necessary modules
from utils import *
import copy
import xml.etree.ElementTree as ET

# Define constant for node tag
NODE_TAG = "node"

# Define base CherryTree XML string
base_cherry = """<?xml version="1.0" encoding="UTF-8"?><cherrytree><bookmarks list=""/></cherrytree>"""

# Function to open a CherryTree document
def open(n):
    tree = ET.parse(n)
    root = tree.getroot()
    return root

# Function to create a new CherryTree document
def create(ct, name):
    tree = ET.ElementTree(ct)
    tree.write(name)

# Function to create a new link element as a string
def newlink_str(l):
    return "<rich_text link=\"webs {}\">{}</rich_text>".format(l, l)

# Function to create a new text element as a string
def newtext_str(t):
    return "<rich_text>{}</rich_text>".format(t)

# Function to create a new text element as an ElementTree element
def newtext(t):
    return ET.fromstring(newtext_str(t))

# Function to create a new link element as an ElementTree element
def new_link(l):
    return ET.fromstring(newlink_str(l))

# Function to create a new image element as a string
def newimg_str(l):
    return '<encoded_png char_offset="0" justification="left" link=""></encoded_png>'

# Function to create a new image element as an ElementTree element
def newimg(l):
    return ET.fromstring(newimg_str(l))

# Function to create a new node element as a string
def newnode_str(name, ts, id=1):
    return '<node name="{}" unique_id="{}" prog_lang="custom-colors" tags="" readonly="0" custom_icon_id="0" is_bold="0" foreground="" ts_creation="{}" ts_lastsave="{}"></node>'.format(
        name, id, ts, ts)

# Function to create a new node element as an ElementTree element
def newnode(l, id=1):
    return ET.fromstring(newnode_str(l, timestamp(), id))

# Function to create a new CherryTree document with a root node
def newdoc(root_name):
    root = ET.fromstring(base_cherry)
    root.append(newnode(root_name))
    return root

# Function to get a list of unique IDs in a CherryTree document
def ids(ct):
    return [int(c.attrib['unique_id']) for c in ct.iter() if 'unique_id' in c.keys()]

# Function to generate a new unique ID for a node in a CherryTree document
def new_id(ids):
    # find major and up + 1
    return max(ids) + 1

# Function to check if an element is a node
def isnode(n):
    return n.tag == NODE_TAG

# Function to get a node element by name
def getnode(ct, name):
    ret = ""
    for c in ct.iter('node'):
        if c.attrib['name'] == name:
            ret = c

    return ret if ret != "" else False

# Function to add a new node to a CherryTree document
def addnode(ct, parent_name, newnode_name):
    new_ct = copy.deepcopy(ct)
    parent = getnode(new_ct, parent_name)
    current_ids = ids(ct)
    new_id_instance = new_id(current_ids)
    newnode_ele = newnode(newnode_name, new_id_instance)
    parent.append(newnode_ele)
    return new_ct

# Function to add a new element to a node in a CherryTree document
def add_ele(ct, node_name, newele):
    new_ct = copy.deepcopy(ct)
    the_node = getnode(new_ct, node_name)
    the_node.append(newele)
    return new_ct
